<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Recommendations | Blood Analysis</title>
    <style>
        :root {
            --primary-color: #2e7aad;
            --secondary-color: #3b637d;
            --light-bg: #f8f9fa;
            --border-color: #e0e7ee;
            --warning-color: #e67e22;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: var(--light-bg);
        }

        .container {
            width: 100%;
            min-width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        header {
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            text-align: center;
        }

        nav {
            background-color: #87bdd8;
            padding: 1rem;
            text-align: center;
        }

        nav a {
            color: white;
            margin: 0 1rem;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background 0.3s;
            font-family: Arial, sans-serif;
        }

        nav a:hover {
            background-color: #1f5f91;
        }


        .tabs {
            display: flex;
            background-color: #f0f7ff;
            border-bottom: 1px solid var(--border-color);
            margin: 0 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 3px solid transparent;
            font-size: 18px;
        }

        .tab:hover {
            background-color: rgba(96, 165, 184, 0.1);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
            margin: 0 20px 20px 20px;
        }

        .tab-content.active {
            display: block;
        }

        .food-item:hover {
            background-color: #f0f7ff;
            /* Light blue hover effect */
            transform: scale(1.02);
            /* Slight scale-up */
            transition: background-color 0.3s, transform 0.2s;
        }

        .section-title {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .parameter-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        .parameter-card h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .parameter-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }

        .status-normal {
            background-color: #e1f5e5;
            color: #2ecc71;
        }

        .status-low {
            background-color: #fdebd0;
            color: #e67e22;
        }

        .status-high {
            background-color: #f5d9d7;
            color: #e74c3c;
        }

        .parameter-card.anemia {
            border-left-color: #e67e22;
        }

        .parameter-card.diabetes {
            border-left-color: #e74c3c;
        }

        .parameter-card.inflammation {
            border-left-color: #9b59b6;
        }

        .food-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .food-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            min-height: 120px;
        }

        .food-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .food-icon {
            font-size: 30px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f7ff;
            border-radius: 50%;
        }

        .Login {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .user-info-link {
            text-decoration: none;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .username {
            font-size: 16px;
            font-weight: bold;
        }

        .exercise-item:hover {
            background-color: #f0f7ff;
            /* Light blue hover effect */
            transform: scale(1.02);
            /* Slight scale-up */
            transition: background-color 0.3s, transform 0.2s;
        }

        .food-title {
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 20px;
            color: var(--secondary-color);
        }

        .food-description {
            font-size: 18px;
            color: #1b1b1b;
        }

        .guidelines {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .exercise-recommendations {
            margin-top: 30px;
        }

        .exercise-item {
            display: flex;
            align-items: flex-start;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .exercise-item-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            height: 40px;
            background-color: #f0f7ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .exercise-item-content {
            flex: 1;
        }

        .exercise-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .exercise-description {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .exercise-steps {
            font-size: 16px;
            margin-bottom: 5px;
            padding-left: 20px;
        }

        .exercise-duration {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .meal-plan-day {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .meal-plan-day h4 {
            margin-bottom: 15px;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .meal-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }

        .meal-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .meal-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .meal-description {
            font-size: 16px;
            color: #555;
        }

        .ai-recommendation {
            background-color: #f0f7ff;
            border-left: 5px solid #62a6b8;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #62a6b8;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .meal-nutrition {
            font-size: 12px;
            color: #3b637d;
            font-style: italic;
            margin-top: 4px;
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
            }



            .tab-content {
                display: block !important;
            }
        }

        @media (max-width: 768px) {
            .food-list {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 20px;
            }

            header p {
                font-size: 12px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 16px;
            }

            .tab-content {
                padding: 15px;
                margin: 0 10px 10px 10px;
            }

            .tabs {
                margin: 0 10px;
            }

            .container {
                padding: 0;
            }
        }

        #logoutBtn:hover {
            background-color: #dc3545;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>

            <div class="Login">
                <a href="profile.html" class="user-info-link">
                    <div class="user-info">
                        <img src="" alt="Profile Picture" class="profile-pic" id="profilePic">
                        <span class="username" id="username"></span>
                    </div>
                </a>
            </div>

            <h1>Diet & Exercise Recommendations</h1>
            <p>Personalized advice based on your blood test results.</p>
        </header>

        <nav>
            <a href="home.html">Home</a>
            <a href="upld.html">Upload Reports</a>
            <a href="progress.html">Track Progress</a>
            <a href="storage.html" aria-label="Storage">Storage</a>
            <a href="#" id="logoutBtn" aria-label="Logout">Logout</a>

        </nav>

        <div class="tabs">
            <div class="tab active" data-tab="overview">Overview</div>
            <div class="tab" data-tab="diet">Diet</div>
            <div class="tab" data-tab="exercise">Exercise</div>
        </div>

        <div id="overview" class="tab-content active">
            <div id="patientSummary">
                <!-- Summary content will be populated here -->
            </div>
        </div>

        <div id="diet" class="tab-content">
            <h3 class="section-title">Dietary Recommendations</h3>
            <div id="dietLoadingIndicator">
                <p>Loading dietary recommendations... <span class="spinner"></span></p>
            </div>
            <div id="dietContent" style="display: none;">
                <div id="dietSummary"></div>
                <h4 class="section-title">Foods to Include</h4>
                <div id="recommendedFoods" class="food-list"></div>
                <h4 class="section-title">Foods to Limit</h4>
                <div id="limitFoods" class="food-list"></div>
                <div class="guidelines">
                    <h4>General Nutrition Guidelines</h4>
                    <ul id="nutritionGuidelines"></ul>
                </div>
            </div>
        </div>

        <div id="exercise" class="tab-content">
            <h3 class="section-title">Exercise Recommendations</h3>
            <div id="exerciseLoadingIndicator">
                <p>Loading exercise recommendations... <span class="spinner"></span></p>
            </div>
            <div id="exerciseContent" style="display: none;">
                <div id="exerciseSummary"></div>
                <div id="exerciseRecommendations" class="exercise-recommendations"></div>
            </div>
        </div>


    </div>

    <script type="module">

        import { getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { checkAuthAndRedirect, displayUserInfo, handleLogout } from './scripts/auth.js';
        import { db } from "./scripts/firebase-storage-config.js";
        import { getCurrentUserId, isAuthenticated } from "./scripts/user-data-service.js";
        import { supabase } from "./scripts/config.js"; // Add this import
        import {
            collection,
            query,
            orderBy,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

        const foodIconMap = {
            "spinach": "🥬",
            "salmon": "🐟",
            "quinoa": "🌾",
            "almonds": "🥜",
            "chicken": "🍗",
            "broccoli": "🥦",
            "sweet potato": "🍠",
            "avocado": "🥑",
            "berries": "🍓",
            "oats": "🥣",
            "processed meats": "🥓",
            "sugary drinks": "🥤",
            "fried foods": "🍟",
            "white bread": "🍞",
            "cake": "🍰",
            "cheese": "🧀",
            "red meat": "🥩",
            "butter": "🧈",
            // Add more mappings as needed
            "default": "🥗" // Fallback icon
        };

        async function initializeApp() {
            const isLoggedIn = await checkAuthAndRedirect();
            if (!isLoggedIn) return;

            const userProfile = await fetchUserProfile();
            if (!userProfile) {
                console.warn("User profile not loaded; proceeding with default recommendations.");
            } else {
                console.log("User profile loaded:", userProfile);
            }

            initializeUI();

            document.getElementById('patientSummary').innerHTML = `
        <div class="parameter-card">
            <h3>Loading Data</h3>
            <p>Fetching your latest blood test data... <span class="spinner"></span></p>
        </div>
    `;

            const latestReport = await getLatestBloodReport();
            if (latestReport) {
                generateRecommendations(latestReport, userProfile);
            } else {
                showNoDataMessage();
            }
        }
        // Function to fetch user profile from Supabase
        async function fetchUserProfile() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) throw error;
                if (!user) {
                    console.error("No authenticated user found");
                    window.location.href = 'index.html';
                    return null;
                }
                return user.user_metadata || {};
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        }
        // Separate UI initialization into its own function
        function initializeUI() {
            // Set up tab functionality
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Log for debugging
                    console.log(`Tab clicked: ${tabId}`);

                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Add active class to selected tab and content
                    this.classList.add('active');
                    const content = document.getElementById(tabId);
                    if (content) {
                        content.classList.add('active');
                    } else {
                        console.error(`Tab content not found: ${tabId}`);
                    }
                });
            });
        }

        // Make sure only one event listener is set up
        document.addEventListener('DOMContentLoaded', initializeApp);


        async function getLatestBloodReport() {
            try {
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.error("No user logged in");
                    return null;
                }

                const reportsRef = collection(db, "users", userId, "bloodReports");
                const q = query(reportsRef, orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No reports found for user");
                    return null;
                }

                const reports = [];
                querySnapshot.forEach((doc) => {
                    const reportData = doc.data();
                    reports.push({
                        id: doc.id,
                        ...reportData,
                        date: reportData.date?.toDate().toISOString() || new Date().toISOString()
                    });
                });

                const expectedParams = ['Hemoglobin', 'Glucose', 'CRP', 'RBC', 'Cholesterol', 'LDL', 'HDL', 'PCV'];
                return reports.find(report =>
                    report.date && report.values && report.analysisHTML &&
                    expectedParams.some(param => report.values[param] != null)
                ) || null;
            } catch (error) {
                console.error("Error fetching latest report from Firestore:", error);
                return null;
            }
        }


        function parseAnalysisHTML(analysisHTML) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(analysisHTML, 'text/html');
            const testResults = [];
            const patientInfo = {};

            const patientInfoDiv = doc.querySelector('div.patient-info');
            if (patientInfoDiv) {
                patientInfoDiv.querySelectorAll('.patient-info-item').forEach(item => {
                    const [key, value] = item.textContent.trim().split(':').map(s => s.trim());
                    if (key && value) patientInfo[key.toLowerCase()] = value;
                });
            }

            const table = doc.querySelector('table.results-table');
            if (table) {
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim().toLowerCase());
                const rows = table.querySelectorAll('tr');
                const testNameIndex = headers.indexOf('test name/parameter');
                const resultIndex = headers.indexOf('result');
                const unitIndex = headers.indexOf('unit');
                const rangeIndex = headers.indexOf('reference range');
                const statusIndex = headers.indexOf('status');

                if (testNameIndex !== -1 && resultIndex !== -1 && statusIndex !== -1) {
                    for (let i = 1; i < rows.length; i++) {
                        const cells = rows[i].querySelectorAll('td');
                        if (cells.length < headers.length) continue;

                        const testName = cells[testNameIndex].textContent.trim();
                        const result = parseFloat(cells[resultIndex].textContent.trim());
                        const unit = unitIndex !== -1 ? cells[unitIndex].textContent.trim() : 'N/A';
                        const range = rangeIndex !== -1 ? cells[rangeIndex].textContent.trim() : 'N/A';
                        const status = cells[statusIndex].textContent.trim();

                        if (!isNaN(result)) {
                            testResults.push({ testName, result, unit, referenceRange: range, status });
                        }
                    }
                }
            }
            return { testResults, patientInfo };
        }

        function showNoDataMessage() {
            document.getElementById('patientSummary').innerHTML = `
                <div class="parameter-card">
                    <h3>No Data Available</h3>
                    <p>No blood test data was found. Please upload a blood test report to receive personalized recommendations.</p>
                    <button id="uploadButton" style="background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-top: 15px;">Upload Blood Test</button>
                </div>
            `;
            document.getElementById('uploadButton').addEventListener('click', () => window.location.href = 'upld.html');
        }

        async function getGeminiRecommendations(bloodData, userProfile) {
            if (!bloodData || !bloodData.analysisHTML) return null;

            const { testResults, patientInfo } = parseAnalysisHTML(bloodData.analysisHTML);
            const testDate = new Date(bloodData.date).toLocaleDateString();

            const testResultsText = testResults.map(result =>
                `- ${result.testName}: ${result.result} ${result.unit} (${result.status}, Reference: ${result.referenceRange})`
            ).join('\n') || 'No test results available.';
            const patientInfoText = Object.entries(patientInfo).map(([key, value]) => `${key}: ${value}`).join(', ');

            // Calculate age from birthdate if available
            let age = null;
            if (userProfile?.birthdate) {
                const birthDate = new Date(userProfile.birthdate);
                age = new Date().getFullYear() - birthDate.getFullYear();
            }

            const apiKey = 'AIzaSyCaBpjdVtlzriQUljPhAmxRem49DNBPFGU';
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const promptText = `Analyze the following blood test report and provide detailed diet and exercise recommendations based on the test results, patient information, and the following user profile:
- Age: ${age || 'Not provided'}
- Gender: ${userProfile?.gender || 'Not provided'}
- Weight: ${userProfile?.weight ? `${userProfile.weight} kg` : 'Not provided'}
- Height: ${userProfile?.height ? `${userProfile.height} cm` : 'Not provided'}
- Medical History: ${userProfile?.medicalInfo || 'Not provided'}
-Country : ${userProfile?.country || 'Not provided'}

Make recommendations highly personalized to the user profile and test results. Do not include generic or fallback recommendations—every suggestion must be directly tied to the analyzed data.

For diet recommendations:
- Provide at least 4 foods to include, each with a specific reason tied to the test results and user profile.
- Provide foods to limit, each with a specific reason tied to the test results and user profile.
- Include nutrition guidelines tailored to the user's age, gender, weight, height, and medical history.Suggest Foods based on the conuntry of the user.


For exercise recommendations, ensure:
- Exactly 5 unique exercises are provided, each tailored to the specific test results, patient condition, and user profile (e.g., adjust intensity based on age/weight).
- Exercises are not generic (e.g., avoid "brisk walking," "swimming," "yoga," or "body strengthening" unless explicitly justified with a unique variation).
- Each exercise has a specific name (e.g., "Goblet Squat," "Plank to Shoulder Tap") and a step-by-step description.
- Each exercise explicitly references the relevant test values and their status (e.g., "Due to low Hemoglobin of 10 g/dL...") and user profile (e.g., "Given your weight of 70 kg...") to justify the recommendation.

Test Results (including status and reference ranges):
${testResultsText}

Test Date:
${testDate}

Patient Information:
${patientInfoText}

Return the response as a JSON object (and ONLY the JSON object, with no additional text, Markdown, or code block formatting) in the following format:

{
    "diet": {
        "summary": "A brief summary of dietary recommendations based on the test results and user profile.",
        "recommendedFoods": [
            {"name": "Food 1", "description": "Why this is recommended based on specific test results and user profile.", "icon": "🍎"},
            {"name": "Food 2", "description": "Why this is recommended based on specific test results and user profile.", "icon": "🥦"}
        ],
        "foodsToLimit": [
            {"name": "Food 1", "description": "Why this should be limited based on specific test results and user profile.", "icon": "🍩"},
            {"name": "Food 2", "description": "Why this should be limited based on specific test results and user profile.", "icon": "🍟"}
        ],
        "nutritionGuidelines": [
            "Guideline 1 tied to test results and user profile",
            "Guideline 2 tied to test results and user profile"
        ]
    },
    "exercise": {
        "summary": "A brief summary of exercise recommendations tailored to the test results and user profile.",
        "exercises": [
            {
                "name": "Specific Exercise Name 1",
                "description": "Why this is recommended, explicitly referencing specific test results and user profile.",
                "steps": [
                    "Step 1: Description of the first step.",
                    "Step 2: Description of the second step.",
                    "Step 3: Continue detailing the steps."
                ],
                "duration": "20 mins",
                "icon": "🏋️"
            },
            {
                "name": "Specific Exercise Name 2",
                "description": "Why this is recommended, explicitly referencing specific test results and user profile.",
                "steps": [
                    "Step 1: Description of the first step.",
                    "Step 2: Description of the second step.",
                    "Step 3: Continue detailing the steps."
                ],
                "duration": "15 mins",
                "icon": "🤸"
            },
            {
                "name": "Specific Exercise Name 3",
                "description": "Why this is recommended, explicitly referencing specific test results and user profile.",
                "steps": [
                    "Step 1: Description of the first step.",
                    "Step 2: Description of the second step.",
                    "Step 3: Continue detailing the steps."
                ],
                "duration": "25 mins",
                "icon": "🏃"
            },
            {
                "name": "Specific Exercise Name 4",
                "description": "Why this is recommended, explicitly referencing specific test results and user profile.",
                "steps": [
                    "Step 1: Description of the first step.",
                    "Step 2: Description of the second step.",
                    "Step 3: Continue detailing the steps."
                ],
                "duration": "30 mins",
                "icon": "🚴"
            },
            {
                "name": "Specific Exercise Name 5",
                "description": "Why this is recommended, explicitly referencing specific test results and user profile.",
                "steps": [
                    "Step 1: Description of the first step.",
                    "Step 2: Description of the second step.",
                    "Step 3: Continue detailing the steps."
                ],
                "duration": "20 mins",
                "icon": "🧘"
            }
        ]
    }
}`;

            console.log(promptText);

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }],
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }
                        ]
                    })
                });

                if (!response.ok) throw new Error(`API request failed: ${response.status}`);

                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    let generatedText = data.candidates[0].content.parts[0].text.trim();
                    generatedText = generatedText.replace(/^```json\n|\n```$/g, '');
                    const jsonMatch = generatedText.match(/{[\s\S]*}/);
                    if (jsonMatch) generatedText = jsonMatch[0];

                    const recommendations = JSON.parse(generatedText);
                    return {
                        diet: recommendations.diet || { summary: '', recommendedFoods: [], foodsToLimit: [], nutritionGuidelines: [] },
                        exercise: recommendations.exercise || { summary: '', exercises: [] }
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching AI recommendations:', error);
                return null;
            }
        }

        async function getOrGenerateRecommendations(bloodData, userProfile) {
            try {
                const userId = await getCurrentUserId();
                if (!userId) {
                    console.error("No user ID available");
                    return null;
                }

                // Check if recommendations already exist for this blood report
                const recommendationsRef = doc(db, "users", userId, "recommendations", bloodData.id);
                const recommendationsDoc = await getDoc(recommendationsRef);

                if (recommendationsDoc.exists()) {
                    // Use existing recommendations
                    console.log("Using existing recommendations from Firebase");
                    return recommendationsDoc.data();
                } else {
                    // Generate new recommendations
                    console.log("Generating new recommendations with Gemini");
                    const aiRecommendations = await getGeminiRecommendations(bloodData, userProfile);

                    // Store the new recommendations
                    if (aiRecommendations) {
                        await setDoc(recommendationsRef, {
                            bloodReportId: bloodData.id,
                            timestamp: new Date(),
                            diet: aiRecommendations.diet,
                            exercise: aiRecommendations.exercise
                        });
                        console.log("New recommendations saved to Firebase");
                        return aiRecommendations;
                    }
                    return null;
                }
            } catch (error) {
                console.error("Error with recommendations:", error);
                // Fallback to generating recommendations without storing
                return await getGeminiRecommendations(bloodData, userProfile);
            }
        }

        async function generateRecommendations(bloodData, userProfile) {
            if (!bloodData || !bloodData.analysisHTML) {
                showNoDataMessage();
                return;
            }

            const { testResults, patientInfo } = parseAnalysisHTML(bloodData.analysisHTML);
            const date = new Date(bloodData.date).toLocaleDateString();
            const patientSummary = document.getElementById('patientSummary');

            patientSummary.innerHTML = `
        <h3 class="section-title">Health Profile</h3>
        <p>Recommendations based on your blood test from ${date}</p>
        <div id="loadingIndicator">
            <p>Generating personalized AI recommendations... <span class="spinner"></span></p>
        </div>
        <div id="abnormalParameters"></div>
    `;

            const abnormalParamsContainer = document.getElementById('abnormalParameters');
            testResults.forEach(result => {
                const testName = result.testName.toLowerCase();
                const status = result.status.toLowerCase();
                let elem;

                if ((testName.includes('hemoglobin') || testName.includes('hb')) && status === 'low') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card anemia';
                    elem.innerHTML = `
                        <h3>Hemoglobin <span class="parameter-status status-low">${status}</span></h3>
                        <p>Your hemoglobin level of ${result.result} ${result.unit} is below the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('glucose') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card diabetes';
                    elem.innerHTML = `
                        <h3>Glucose <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your glucose level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('crp') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card inflammation';
                    elem.innerHTML = `
                        <h3>C-Reactive Protein <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your CRP level of ${result.result} ${result.unit} is elevated (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('rbc') && status === 'low') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card anemia';
                    elem.innerHTML = `
                        <h3>Red Blood Cell Count <span class="parameter-status status-low">${status}</span></h3>
                        <p>Your RBC count of ${result.result} ${result.unit} is below the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('cholesterol') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>Cholesterol <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your cholesterol level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('ldl') && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>LDL Cholesterol <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your LDL level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                } else if (testName.includes('hdl') && status === 'low') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>HDL Cholesterol <span class="parameter-status status-low">${status}</span></h3>
                        <p>Your HDL level of ${result.result} ${result.unit} is below the normal range (${result.referenceRange}).</p>
                    `;
                } else if ((testName.includes('pcv') || testName.includes('hematocrit')) && status === 'high') {
                    elem = document.createElement('div');
                    elem.className = 'parameter-card';
                    elem.innerHTML = `
                        <h3>PCV/Hematocrit <span class="parameter-status status-high">${status}</span></h3>
                        <p>Your PCV level of ${result.result} ${result.unit} is above the normal range (${result.referenceRange}).</p>
                    `;
                }

                if (elem) abnormalParamsContainer.appendChild(elem);
            });

            if (!abnormalParamsContainer.children.length) {
                abnormalParamsContainer.innerHTML = `
                    <div class="parameter-card">
                        <h3>Overall Health <span class="parameter-status status-normal">Normal</span></h3>
                        <p>Your blood test results appear to be within normal ranges.</p>
                    </div>
                `;
            }
            const aiRecommendations = await getOrGenerateRecommendations(bloodData, userProfile);
            document.getElementById('loadingIndicator').style.display = 'none';

            if (!aiRecommendations) {
                patientSummary.innerHTML += `
            <div class="parameter-card">
                <h3>Error</h3>
                <p>Unable to generate recommendations at this time. Please try again later.</p>
            </div>
        `;
                return;
            }

            // Store the recommendations in Firebase
            try {
                const userId = await getCurrentUserId();
                if (userId) {
                    // Create a document with the blood report ID to link recommendations to the report
                    const recommendationsRef = doc(db, "users", userId, "recommendations", bloodData.id);
                    await setDoc(recommendationsRef, {
                        bloodReportId: bloodData.id,
                        timestamp: new Date(),
                        diet: aiRecommendations.diet,
                        exercise: aiRecommendations.exercise
                    });
                    console.log("Recommendations saved to Firebase");
                }
            } catch (error) {
                console.error("Error saving recommendations to Firebase:", error);
            }

            generateDietRecommendations(aiRecommendations);
            generateExerciseRecommendations(aiRecommendations);
        }


        function generateDietRecommendations(aiRecommendations) {
            const dietLoadingIndicator = document.getElementById('dietLoadingIndicator');
            const dietContent = document.getElementById('dietContent');
            const dietSummary = document.getElementById('dietSummary');
            const recommendedFoods = document.getElementById('recommendedFoods');
            const limitFoods = document.getElementById('limitFoods');
            const nutritionGuidelines = document.getElementById('nutritionGuidelines');

            dietSummary.innerHTML = `
        <div class="ai-recommendation">
            <p>${aiRecommendations.diet.summary}</p>
        </div>
    `;

            recommendedFoods.innerHTML = '';
            aiRecommendations.diet.recommendedFoods.forEach(food => {
                const foodNameLower = food.name.toLowerCase();
                const icon = foodIconMap[foodNameLower] || food.icon || foodIconMap["default"];
                const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(food.name)}`;

                const foodItem = document.createElement('a');
                foodItem.className = 'food-item';
                foodItem.href = googleSearchUrl;
                foodItem.target = '_blank'; // Open in new tab
                foodItem.style.cursor = 'pointer'; // Indicate clickability
                foodItem.style.textDecoration = 'none'; // Remove underline from link
                foodItem.style.color = 'inherit'; // Inherit text color
                foodItem.innerHTML = `
            <div class="food-icon">${icon}</div>
            <div class="food-title">${food.name}</div>
            <div class="food-description">${food.description}</div>
        `;
                recommendedFoods.appendChild(foodItem);
            });

            limitFoods.innerHTML = '';
            aiRecommendations.diet.foodsToLimit.forEach(food => {
                const foodNameLower = food.name.toLowerCase();
                const icon = foodIconMap[foodNameLower] || food.icon || foodIconMap["default"];
                const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(food.name)}`;

                const foodItem = document.createElement('a');
                foodItem.className = 'food-item';
                foodItem.href = googleSearchUrl;
                foodItem.target = '_blank'; // Open in new tab
                foodItem.style.cursor = 'pointer'; // Indicate clickability
                foodItem.style.textDecoration = 'none'; // Remove underline from link
                foodItem.style.color = 'inherit'; // Inherit text color
                foodItem.innerHTML = `
            <div class="food-icon">${icon}</div>
            <div class="food-title">${food.name}</div>
            <div class="food-description">${food.description}</div>
        `;
                limitFoods.appendChild(foodItem);
            });

            nutritionGuidelines.innerHTML = '';
            aiRecommendations.diet.nutritionGuidelines.forEach(guideline => {
                const li = document.createElement('li');
                li.textContent = guideline;
                nutritionGuidelines.appendChild(li);
            });

            dietLoadingIndicator.style.display = 'none';
            dietContent.style.display = 'block';
        }


        function generateExerciseRecommendations(aiRecommendations) {
            const exerciseLoadingIndicator = document.getElementById('exerciseLoadingIndicator');
            const exerciseContent = document.getElementById('exerciseContent');
            const exerciseSummary = document.getElementById('exerciseSummary');
            const exerciseRecommendations = document.getElementById('exerciseRecommendations');

            exerciseSummary.innerHTML = `
        <div class="ai-recommendation">
            <p>${aiRecommendations.exercise.summary}</p>
        </div>
    `;

            exerciseRecommendations.innerHTML = '';
            aiRecommendations.exercise.exercises.forEach(exercise => {
                const googleSearchUrl = `https://www.youtube.com/search?q=${encodeURIComponent(exercise.name)}`;

                const exerciseItem = document.createElement('a');
                exerciseItem.className = 'exercise-item';
                exerciseItem.href = googleSearchUrl;
                exerciseItem.target = '_blank'; // Open in new tab
                exerciseItem.style.cursor = 'pointer'; // Indicate clickability
                exerciseItem.style.textDecoration = 'none'; // Remove underline from link
                exerciseItem.style.color = 'inherit'; // Inherit text color
                exerciseItem.innerHTML = `
            <div class="exercise-item-icon">${exercise.icon || '🏃‍♂️'}</div>
            <div class="exercise-item-content">
                <div class="exercise-title">${exercise.name}</div>
                <div class="exercise-description">${exercise.description}</div>
                <ol class="exercise-steps">
                    ${exercise.steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
                <div class="exercise-duration">Duration: ${exercise.duration}</div>
            </div>
        `;
                exerciseRecommendations.appendChild(exerciseItem);
            });

            exerciseLoadingIndicator.style.display = 'none';
            exerciseContent.style.display = 'block';
        }
        document.addEventListener('DOMContentLoaded', initializeApp);


    </script>


</body>

</html>